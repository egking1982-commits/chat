<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø­ÙŠØ§Ø© - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… 2026</title>
    <style>
        :root { --main: #d63384; --admin: #2c3e50; --sent: #dcf8c6; --bg: #e5ddd5; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; overflow: hidden; }
        
        @keyframes flash { 0% { background: var(--main); } 100% { background: white; } }
        .new-msg-flash { animation: flash 0.5s ease-in-out; }

        .auth-container { background: white; width: 85%; max-width: 350px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .auth-container input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-main { width: 100%; padding: 12px; background: var(--main); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background: none; color: var(--main); border: none; margin-top: 15px; cursor: pointer; text-decoration: underline; font-size: 14px; }
        
        #chat-app { display: none; height: 100%; width: 100%; flex-direction: column; background: white; }
        .mobile-header { background: var(--main); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: var(--bg); }
        
        .msg-wrapper { max-width: 85%; display: flex; flex-direction: column; }
        .bubble { padding: 10px; border-radius: 15px; background: white; position: relative; min-width: 100px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { align-self: flex-start; }
        .received { align-self: flex-end; }
        .sent .bubble { background: var(--sent); }
        
        .admin-tools { font-size: 11px; margin-top: 5px; display: flex; gap: 8px; border-top: 1px solid #eee; padding-top: 5px; }
        .btn-del { color: red; cursor: pointer; font-weight: bold; }
        .btn-ban { color: orange; cursor: pointer; font-weight: bold; }
        .btn-edit { color: blue; cursor: pointer; margin-right: 5px; font-weight: bold; }

        .input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; }
        .msg-input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        .attach-btn { font-size: 20px; color: #666; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

    <div id="auth-screen" class="auth-container">
        <h2 id="auth-title" style="color:var(--main)">ğŸ” Ù…Ù„ØªÙ‚Ù‰ 2026</h2>
        <input type="text" id="user-id" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="user-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ Pass Key">
        <button id="loginBtn" class="btn-main">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
        <button id="registerBtn" class="btn-main" style="display:none; background:#28a745;">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†</button>
        <button id="toggleAuth" class="btn-secondary">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <div id="chat-app">
        <div id="header" class="mobile-header">
            <span id="user-tag">Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</span>
            <span id="logoutBtn" style="cursor:pointer">ğŸšª Ø®Ø±ÙˆØ¬</span>
        </div>
        <div class="messages" id="chatBox"></div>
        <div class="input-area">
            <span class="attach-btn" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù" onclick="alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø§Ù„Ø±ÙØ¹ Ù‚Ø±ÙŠØ¨Ø§Ù‹')">ğŸ“</span>
            <input type="text" id="tInp" class="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." enterkeyhint="send">
            <button id="sendBtn" style="border:none; background:none; font-size:24px; cursor:pointer;">âœˆï¸</button>
        </div>
    </div>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onChildRemoved, onChildChanged, set, get, child, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAQoBgXB_Iq0Ga_UmJkwifQ7kqbHF1FGPY",
            authDomain: "chat-8fc29.firebaseapp.com",
            projectId: "chat-8fc29",
            storageBucket: "chat-8fc29.firebasestorage.app",
            messagingSenderId: "86774347462",
            appId: "1:86774347462:web:486b16cea75191187009c7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentUser = "";
        let isAdmin = false;

        // Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª (Ø¯Ø®ÙˆÙ„/ØªØ³Ø¬ÙŠÙ„)
        const toggleBtn = document.getElementById('toggleAuth');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const authTitle = document.getElementById('auth-title');

        toggleBtn.onclick = () => {
            if (loginBtn.style.display !== 'none') {
                authTitle.innerText = "ğŸ’ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'block';
                toggleBtn.innerText = "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ";
            } else {
                authTitle.innerText = "ğŸ” Ù…Ù„ØªÙ‚Ù‰ 2026";
                loginBtn.style.display = 'block';
                registerBtn.style.display = 'none';
                toggleBtn.innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
            }
        };

        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        registerBtn.onclick = async () => {
            const u = document.getElementById('user-id').value.trim();
            const p = document.getElementById('user-pass').value.trim();
            if (!u || !p) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            const check = await get(child(ref(db), `users/${u}`));
            if (check.exists()) return alert("Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
            await set(ref(db, 'users/' + u), { pass: p, isBanned: false });
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
            toggleBtn.click();
        };

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        loginBtn.onclick = async () => {
            const u = document.getElementById('user-id').value.trim();
            const p = document.getElementById('user-pass').value.trim();
            
            if (p === "2026") { 
                isAdmin = true; 
                currentUser = u + " (Ø§Ù„Ø£Ø¯Ù…Ù†) â­"; 
                startApp();
            } else {
                const snap = await get(child(ref(db), `users/${u}`));
                if (snap.exists() && snap.val().pass === p) {
                    if (snap.val().isBanned) return alert("Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø§Øª.");
                    currentUser = u;
                    startApp();
                } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Pass Key ØºÙŠØ± ØµØ­ÙŠØ­"); }
            }
        };

        function startApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('chat-app').style.display = 'flex';
            document.getElementById('user-tag').innerText = currentUser;
            if(isAdmin) document.getElementById('header').style.background = "var(--admin)";
            initChatListeners();
        }

        function initChatListeners() {
            const msgsRef = ref(db, 'messages');

            // Ø±ØµØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Real-time)
            onChildAdded(msgsRef, (snap) => {
                const data = snap.val();
                const box = document.getElementById('chatBox');
                const isMe = data.sender === currentUser;
                
                const div = document.createElement('div');
                div.className = `msg-wrapper ${isMe ? 'sent' : 'received'}`;
                div.id = `msg-${snap.key}`;
                
                let tools = "";
                if (isAdmin) tools += `<span class="btn-del" data-id="${snap.key}">ğŸ—‘ Ø­Ø°Ù</span>`;
                if (isAdmin && !isMe) tools += `<span class="btn-ban" data-user="${data.sender}">ğŸš« Ø­Ø¸Ø±</span>`;
                if (isMe) tools += `<span class="btn-edit" data-id="${snap.key}" data-text="${data.text}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</span>`;

                div.innerHTML = `
                    <div style="font-size:10px; color:#666; margin-bottom:2px;">${data.sender}</div>
                    <div class="bubble">
                        <span id="text-${snap.key}">${data.text}</span>
                        ${tools ? `<div class="admin-tools">${tools}</div>` : ''}
                    </div>
                `;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;

                // Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
                if (data.sender !== currentUser) {
                    document.getElementById('notifSound').play().catch(()=>{});
                    document.body.classList.add('new-msg-flash');
                    setTimeout(() => document.body.classList.remove('new-msg-flash'), 500);
                }

                // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù€ Reload
                div.querySelectorAll('.btn-del').forEach(b => b.onclick = () => deleteMsg(b.dataset.id));
                div.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => editMsg(b.dataset.id, b.dataset.text));
                div.querySelectorAll('.btn-ban').forEach(b => b.onclick = () => banUser(b.dataset.user));
            });

            // Ø±ØµØ¯ Ø§Ù„Ø­Ø°Ù (ÙŠØ®ØªÙÙŠ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹)
            onChildRemoved(msgsRef, (snap) => {
                const el = document.getElementById(`msg-${snap.key}`);
                if (el) el.remove();
            });

            // Ø±ØµØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            onChildChanged(msgsRef, (snap) => {
                const txtEl = document.getElementById(`text-${snap.key}`);
                if (txtEl) txtEl.innerText = snap.val().text;
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        document.getElementById('sendBtn').onclick = () => {
            const t = document.getElementById('tInp');
            if(t.value.trim()){
                push(ref(db, 'messages'), { sender: currentUser, text: t.value, time: serverTimestamp() });
                t.value = "";
            }
        };

        // Ø¯Ø¹Ù… Ø²Ø± Enter
        document.getElementById('tInp').onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('sendBtn').click(); };

        // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙØ¹Ù„ÙŠ
        document.getElementById('logoutBtn').onclick = () => { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) location.reload(); };

        // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø¯ÙˆÙ† Reload)
        async function deleteMsg(id) {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await remove(ref(db, `messages/${id}`));
            }
        }

        async function editMsg(id, oldText) {
            const newText = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", oldText);
            if(newText && newText !== oldText) {
                await update(ref(db, `messages/${id}`), { text: newText });
            }
        }

        async function banUser(user) {
            if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user}ØŸ`)) {
                await update(ref(db, `users/${user}`), { isBanned: true });
                alert("ØªÙ… Ø§Ù„Ø­Ø¸Ø± Ø¨Ù†Ø¬Ø§Ø­.");
            }
        }
    </script>
</body>
</html>
