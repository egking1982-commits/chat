<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø­ÙŠØ§Ø© - Ù†Ø³Ø®Ø© Firebase Live</title>
    <style>
        :root { --main: #d63384; --dark: #2c3e50; --sent: #dcf8c6; --bg: #e5ddd5; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; overflow: hidden; touch-action: manipulation; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .auth-container { background: white; width: 85%; max-width: 350px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .auth-container input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª */
        #chat-app { display: none; height: 100%; width: 100%; flex-direction: column; background: white; }
        .mobile-header { background: var(--main); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; z-index: 10; }
        
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: var(--bg); }
        .msg-wrapper { max-width: 85%; display: flex; flex-direction: column; position: relative; }
        .sent { align-self: flex-start; }
        .received { align-self: flex-end; }
        
        .bubble { padding: 10px 14px; border-radius: 18px; background: white; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; word-wrap: break-word; }
        .sent .bubble { background: var(--sent); border-top-right-radius: 4px; }
        .received .bubble { border-top-left-radius: 4px; }
        
        .msg-info { font-size: 10px; color: #888; margin-top: 4px; padding: 0 5px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .msg-input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 16px; -webkit-appearance: none; }
        .icon { font-size: 26px; cursor: pointer; color: #555; padding: 5px; user-select: none; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        #side-drawer { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: var(--dark); color: white; transition: 0.3s; z-index: 2000; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; }
        
        .rec-active { color: red !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        .admin-section { background: #34495e; margin: 10px; padding: 15px; border-radius: 10px; font-size: 14px; }
        .admin-section input { width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: none; font-size: 14px; }
        .admin-btn { background: var(--main); color: white; border: none; width: 100%; padding: 10px; border-radius: 5px; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen" class="auth-container">
        <h2 style="color:var(--main)">ğŸ’ Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©</h2>
        <input type="text" id="user-id" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="user-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="loginBtn" style="width:100%; padding:12px; background:var(--main); color:white; border:none; border-radius:10px; font-size:16px; font-weight: bold;">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
    </div>

    <div id="chat-app">
        <div class="mobile-header">
            <span id="openMenu" style="cursor:pointer; font-size:24px;">â˜°</span>
            <span>Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</span>
            <div id="admin-indicator" style="display:none; font-size:10px; background:gold; color:black; padding:2px 5px; border-radius:4px;">ADMIN</div>
        </div>
        <div class="messages" id="chatBox"></div>
        <div class="input-area">
            <label class="icon">ğŸ“<input type="file" id="fInp" style="display:none"></label>
            <input type="text" id="tInp" class="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." enterkeyhint="send">
            <span class="icon" id="micBtn">ğŸ¤</span>
            <span class="icon" id="sendBtn" style="color:var(--main)">âœˆï¸</span>
        </div>
    </div>

    <div id="side-drawer">
        <div style="padding:20px; background:#1a252f;"><b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©</b></div>
        <div id="admin-tools" style="display: none;">
            <div class="admin-section">
                <b style="color: gold; display: block; margin-bottom: 5px;">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</b>
                <input type="text" id="new-u" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="text" id="new-p" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="admin-btn" id="saveUser">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
        <div style="padding:15px; cursor: pointer;" onclick="location.reload()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
    </div>
    <div class="overlay" id="overlay"></div>

    <audio id="snd-out" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="snd-in" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ (Ù…Ø¯Ù…Ø¬Ø©)
        const firebaseConfig = {
            apiKey: "AIzaSyClnZptClETDJK5VRGxY0jZXfTva4eTxBo",
            authDomain: "firechat-a2f3e.firebaseapp.com",
            projectId: "firechat-a2f3e",
            storageBucket: "firechat-a2f3e.firebasestorage.app",
            messagingSenderId: "460636544730",
            appId: "1:460636544730:web:29784ea654efac6b740fe3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        let currentUser = "";
        let isAdmin = false;

        // Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('loginBtn').onclick = async () => {
            const u = document.getElementById('user-id').value.trim();
            const p = document.getElementById('user-pass').value.trim();

            if(u === "admin" && p === "admin123") {
                loginSuccess(u, true);
            } else {
                const snapshot = await get(child(ref(db), `users/${u}`));
                if (snapshot.exists() && snapshot.val().pass === p) {
                    loginSuccess(u, false);
                } else {
                    alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¶Ø§Ù");
                }
            }
        };

        function loginSuccess(user, adminStatus) {
            currentUser = user;
            isAdmin = adminStatus;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-app').style.display = 'flex';
            if(isAdmin) {
                document.getElementById('admin-indicator').style.display = 'block';
                document.getElementById('admin-tools').style.display = 'block';
            }
            loadMessages();
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
        document.getElementById('saveUser').onclick = () => {
            const nu = document.getElementById('new-u').value.trim();
            const np = document.getElementById('new-p').value.trim();
            if(nu && np) {
                set(ref(db, 'users/' + nu), { pass: np });
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById('new-u').value = "";
                document.getElementById('new-p').value = "";
            }
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        const tInp = document.getElementById('tInp');
        const sendBtn = document.getElementById('sendBtn');

        const pushMsg = (data) => {
            push(ref(db, 'messages'), {
                ...data,
                sender: currentUser,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
        };

        sendBtn.onclick = () => {
            if(tInp.value.trim()) {
                pushMsg({ text: tInp.value, type: 'text' });
                tInp.value = "";
                tInp.focus();
            }
        };

        tInp.onkeypress = (e) => { if(e.key === "Enter") sendBtn.click(); };

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø§ÙŠÙ
        function loadMessages() {
            onChildAdded(ref(db, 'messages'), (snapshot) => {
                displayMsg(snapshot.val());
            });
        }

        function displayMsg(data) {
            const box = document.getElementById('chatBox');
            const isMe = data.sender === currentUser;
            const wrap = document.createElement('div');
            wrap.className = `msg-wrapper ${isMe ? 'sent' : 'received'}`;
            
            let content = data.text;
            if(data.type === 'image') content = `<img src="${data.url}" style="max-width:100%; border-radius:10px;">`;
            if(data.type === 'audio') content = `<audio controls src="${data.url}" style="width:200px;"></audio>`;
            if(data.type === 'file') content = `<a href="${data.url}" target="_blank">ğŸ“„ Ù…Ù„Ù Ù…Ø±ÙÙ‚: ${data.name}</a>`;

            wrap.innerHTML = `
                <div class="msg-info">${data.sender}</div>
                <div class="bubble">${content}</div>
                <div class="msg-info">${data.time}</div>
            `;
            box.appendChild(wrap);
            box.scrollTop = box.scrollHeight;
            if(!isMe) document.getElementById('snd-in').play();
            else document.getElementById('snd-out').play();
        }

        // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        document.getElementById('fInp').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const fileRef = sRef(storage, 'uploads/' + Date.now() + "_" + file.name);
            const snap = await uploadBytes(fileRef, file);
            const url = await getDownloadURL(snap.ref);
            const type = file.type.startsWith('image/') ? 'image' : 'file';
            pushMsg({ type, url, name: file.name });
        };

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
        let rec, chunks = [];
        document.getElementById('micBtn').onclick = async function() {
            if(this.classList.contains('rec-active')) {
                rec.stop(); this.classList.remove('rec-active');
            } else {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    rec = new MediaRecorder(s);
                    chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);
                    rec.onstop = async () => {
                        const blob = new Blob(chunks, {type:'audio/ogg'});
                        const fileRef = sRef(storage, 'voice/' + Date.now() + ".ogg");
                        const snap = await uploadBytes(fileRef, blob);
                        const url = await getDownloadURL(snap.ref);
                        pushMsg({ type: 'audio', url });
                    };
                    rec.start(); this.classList.add('rec-active');
                } catch(e) { alert("Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø·Ù„ÙˆØ¨"); }
            }
        };

        // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        document.getElementById('openMenu').onclick = () => {
            document.getElementById('side-drawer').style.right = '0';
            document.getElementById('overlay').style.display = 'block';
        };
        document.getElementById('overlay').onclick = () => {
            document.getElementById('side-drawer').style.right = '-280px';
            document.getElementById('overlay').style.display = 'none';
        };
    </script>
</body>
</html>
